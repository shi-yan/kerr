# Kerr iOS App

Native iOS application for Kerr - peer-to-peer remote shell access with file browsing and terminal capabilities.

## Architecture

```
┌─────────────────────────────────┐
│   Swift UI (SwiftUI + SwiftTerm)│
│   - File Browser                │
│   - Terminal Interface          │
│   - Connection Management       │
└────────────┬────────────────────┘
             │ UniFFI Bindings
┌────────────▼────────────────────┐
│   Rust Core (kerr-ios)          │
│   - Iroh P2P networking         │
│   - Session management          │
│   - File operations             │
│   - Shell protocol              │
└─────────────────────────────────┘
```

## Features

- **File Browser**: Browse and download files from remote servers
- **Terminal**: Interactive shell access using SwiftTerm
- **P2P Connection**: Direct encrypted connections using Iroh QUIC
- **NAT Traversal**: Automatic firewall/NAT penetration

## Prerequisites

1. **macOS** with Xcode 15.0 or later
2. **Rust** toolchain (install via [rustup](https://rustup.rs))
3. **UniFFI bindgen**:
   ```bash
   cargo install uniffi-bindgen --version 0.28
   ```

## Building the Project

### 1. Build Rust Library

Navigate to the `kerr-ios` directory and run the build script:

```bash
cd ../kerr-ios
./build-ios.sh
```

This will:
- Build Rust library for all iOS targets (device + simulator)
- Generate Swift bindings via UniFFI
- Create universal static libraries in `ios/Frameworks/`
- Generate Swift wrappers in `ios/Generated/`

### 2. Open in Xcode

1. Open `ios/KerrApp/KerrApp.xcodeproj` in Xcode (you'll need to create this first)
2. Or create a new iOS app project in Xcode:
   ```
   File → New → Project → iOS → App
   Product Name: KerrApp
   Interface: SwiftUI
   Language: Swift
   ```

### 3. Add Generated Files to Xcode

1. Drag `ios/Generated/kerr_ios.swift` into your Xcode project
2. Add bridging header for C FFI:
   - Create a new header file: `KerrApp-Bridging-Header.h`
   - Add: `#import "kerr_iosFFI.h"`
   - Set in Build Settings → Swift Compiler → Objective-C Bridging Header

### 4. Link Static Libraries

In Xcode project settings:
1. Go to target → General → Frameworks, Libraries, and Embedded Content
2. Click `+` and add:
   - `ios/Frameworks/libkerr_ios.a` (for iOS device builds)
   - `ios/Frameworks/libkerr_ios_sim.a` (for simulator builds)

Or use the following build settings:
```
OTHER_LDFLAGS = -L$(PROJECT_DIR)/ios/Frameworks -lkerr_ios
```

### 5. Add SwiftTerm Dependency

Add SwiftTerm via Swift Package Manager:
1. File → Add Package Dependencies
2. Enter: `https://github.com/migueldeicaza/SwiftTerm`
3. Select version: `main` branch or latest release

### 6. Build and Run

Select your target (simulator or device) and build:
- **Simulator**: Uses `libkerr_ios_sim.a`
- **Device**: Uses `libkerr_ios.a`

## Project Structure

```
ios/
├── KerrApp/                    # Swift app source
│   ├── KerrApp.swift          # App entry point
│   ├── ContentView.swift      # Main view switcher
│   ├── ConnectionManager.swift # Connection state management
│   ├── ConnectionView.swift   # Connection setup UI
│   ├── FileBrowserView.swift  # File browser UI
│   └── TerminalView.swift     # Terminal UI (SwiftTerm integration)
├── Generated/                  # Generated by build-ios.sh
│   ├── kerr_ios.swift         # Swift bindings
│   └── kerr_iosFFI.h          # C FFI headers
└── Frameworks/                 # Built Rust libraries
    ├── libkerr_ios.a          # iOS device (ARM64)
    └── libkerr_ios_sim.a      # iOS simulator (universal)
```

## Usage

### Connecting to a Server

1. Launch the app
2. Paste or scan a Kerr connection string
3. Tap "Connect"

The connection string is base64-encoded and contains:
- Server's public key
- Direct IP addresses
- Relay server information

### File Browser

- Tap folders to navigate
- Tap files to see download options
- Use back button to go up one directory

### Terminal

1. Switch to "Terminal" tab
2. Tap "Start Shell"
3. Type commands and press Send
4. Output appears in the terminal view

## Development

### Rebuilding Rust Library

After modifying Rust code in `../kerr-ios/src/`:

```bash
cd ../kerr-ios
./build-ios.sh
```

Then clean and rebuild in Xcode (⌘+Shift+K, then ⌘+B).

### Testing

Run on iOS Simulator:
```bash
# In Xcode, select simulator and press ⌘+R
```

Run on Physical Device:
1. Connect iPhone/iPad
2. Select device in Xcode
3. Configure signing certificate
4. Press ⌘+R

### Debugging

Rust logs can be viewed in Xcode console. To enable verbose logging, set environment variables in Xcode scheme:
- `RUST_LOG=debug`

## API Overview

### Swift → Rust Interface

```swift
// Create endpoint
let endpoint = try createEndpoint()

// Connect to server
let session = try endpoint.connect(connectionString: connStr)

// File operations
let browser = try session.fileBrowser()
let files = try browser.listDir(path: "/home")
let data = try browser.downloadFile(path: "/home/file.txt")

// Shell session
class MyCallback: ShellCallback {
    func onOutput(data: String) { print(data) }
    func onError(message: String) { print("Error: \(message)") }
    func onClose() { print("Closed") }
}

let shell = try session.startShell(callback: MyCallback())
try shell.sendInput(data: "ls -la\n")
try shell.resize(cols: 80, rows: 24)
```

## Troubleshooting

### Build Errors

**Error: "No such module 'kerr_ios'"**
- Ensure `ios/Generated/kerr_ios.swift` is added to your Xcode project
- Check that the file is in the target membership

**Error: "Undefined symbols for architecture arm64"**
- Verify static libraries are linked in Build Phases → Link Binary With Libraries
- Check that library search paths include `$(PROJECT_DIR)/ios/Frameworks`

**Error: "Rust panic" or "Thread crashed"**
- Check Rust library was built for correct architecture
- For simulator: Use `libkerr_ios_sim.a`
- For device: Use `libkerr_ios.a`

### Runtime Errors

**Connection fails**
- Verify connection string is valid
- Check network connectivity
- Ensure server is running and accessible

**File operations fail**
- Check file paths are absolute (start with `/`)
- Verify permissions on remote server

## License

Same as parent Kerr project.

## Contributing

See parent project README for contribution guidelines.
